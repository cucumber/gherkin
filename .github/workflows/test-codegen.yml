name: test-codegen

on:
  push:
    branches:
      - main
      - renovate/**
  pull_request:
    branches:
      - main
  workflow_call:

jobs:
  test-codegen:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Perl uses make to generate files other than the parser
      # Please do not repeat this pattern if possible.
      - name: install cpanm and multiple modules
        uses: perl-actions/install-with-cpanm@v1
        with:
          cpanfile: "perl/cpanfile"

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '5.0.x'

      - name: install berp
        run: |
          dotnet tool update Berp --version 1.3.0 --tool-path ~/bin
          echo "~/bin" >> $GITHUB_PATH

      - name: generate code for all languages
        run: |
          make clean-all
          make generate-all

      - name: check the repo is still clean after generation
        run: |
          git status --porcelain
          git diff HEAD
          [ -z "$(git status --porcelain)" ]
