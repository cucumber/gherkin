#!/usr/bin/env php
<?php declare(strict_types=1);

require __DIR__ . '/../vendor/autoload.php';

use Cucumber\Gherkin\GherkinParser;
use Cucumber\Messages\Source;
use Cucumber\Messages\Streams\NdJson\NdJsonStreamWriter;

assert(is_array($argv), "Script must be run from the command line");

$options = ['predictable-ids', 'no-source', 'no-ast', 'no-pickles'];

$selectedOptions = getopt('', $options, $restIndex);
assert(is_array($selectedOptions), "Could not get options");

$paths = array_slice($argv, $restIndex);

// lazily-read list of Sources
$sources = (
    /** @param list<string> $paths */
    function (array $paths) {
        foreach ($paths as $path) {
            $contents = file_get_contents($path);
            assert(is_string($contents), "Could not read " . $path);
            yield new Source(uri: $path, data: $contents);
        }
    }
)($paths);

$parser = new GherkinParser(
    predictableIds: array_key_exists('predictable-ids', $selectedOptions),
    includeSource: !array_key_exists('no-source', $selectedOptions),
    includeGherkinDocument: !array_key_exists('no-ast', $selectedOptions),
    includePickles: !array_key_exists('no-pickles', $selectedOptions),
);
$envelopes = $parser->parse($sources);

$file = 'php://stdout';
$output = fopen($file, 'w');
assert(is_resource($output), "Could not open " . $file);
$writer = NdJsonStreamWriter::fromFileHandle($output);
$writer->writeEnvelopes($envelopes);
